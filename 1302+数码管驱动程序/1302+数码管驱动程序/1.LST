C51 COMPILER V9.00   1                                                                     11/09/2011 14:08:44 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE 1
OBJECT MODULE PLACED IN 1.OBJ
COMPILER INVOKED BY: D:\installs soft disk\Keil C51\C51\BIN\C51.EXE 1.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*****12M晶振stc89c52单片机*********************/
   2          
   3          
   4          #include<stc12.h>
   5          #include<intrins.h>
   6          #define uint unsigned int
   7          #define uchar unsigned char
   8          
   9          uchar second1,second2,minute1,minute2,hour1,hour2,day1,day2,month1,month2,week1,week2,year1,year2;
  10          uchar time_data[7];//显示缓冲区
  11          uchar  table[]={0Xc0,0XF9,0XA4,0XB0,0X99,0X92,0X82,0XF8,0X80,0X90};   //0―9段码
  12          uchar table_dp[]={0x40,0x79,0x24,0x30,0x19,0x12,0x02,0x78,0x00,0x10}; //带秒闪0―9段码数组
  13          uchar  bufer[]={0x7f,0xbf,0xdf,0xef};
  14          //uchar i;
  15          
  16                   
  17          sbit sck=P1^0;
  18          sbit io=P1^1;
  19          sbit rst=P1^2;
  20          
  21          /*ds1302驱动程序*/
  22           
  23            void write_ds1302_byte(uchar dat)     //写单字节
  24            {uchar i;
  25   1         for(i=0;i<8;i++)
  26   1         {sck=0;
  27   2          io=dat&0x01;
  28   2              dat>>=1;
  29   2              sck=1;
  30   2         }
  31   1        }
  32          
  33          
  34            void write_ds1302(uchar add,uchar dat)
  35            {rst=0;
  36   1         _nop_();
  37   1         sck=0;
  38   1         _nop_();
  39   1         rst=1;
  40   1         _nop_();
  41   1         write_ds1302_byte(add);
  42   1         write_ds1302_byte(dat);
  43   1         rst=0;
  44   1         _nop_();
  45   1         io=1;
  46   1         sck=1;
  47   1         }
  48            
  49            uchar read_ds1302(uchar add)
  50            
  51            {uchar i,value;
  52   1          rst=0;
  53   1          _nop_();
  54   1              sck=0;
  55   1              _nop_();
C51 COMPILER V9.00   1                                                                     11/09/2011 14:08:44 PAGE 2   

  56   1              rst=1;
  57   1              _nop_();
  58   1              write_ds1302_byte(add);
  59   1              for(i=0;i<8;i++)
  60   1              {
  61   2              value=value>>1;
  62   2              sck=0;
  63   2              if(io)
  64   2              value=value|0x80;
  65   2              sck=1;
  66   2              }
  67   1              rst=0;
  68   1              _nop_();
  69   1              sck=0;
  70   1              _nop_();           
  71   1              sck=1;
  72   1              io=1;
  73   1              return value;
  74   1       }
  75                  
  76          
  77           void set_rtc(uchar add,value)//设定时钟函数注意 BCD码的转换
  78          { 
  79   1        uchar temp,temp1,temp2;
  80   1        write_ds1302(0x8e,0x00);//去除写保护
  81   1        temp1=value/10; //分离十位
  82   1        temp2=value%10;//分离个位
  83   1        temp=temp2+temp1*16; //转换完成BCD码
  84   1        write_ds1302(add,temp);
  85   1        write_ds1302(0x8e,0x80); //加上写保护
  86   1      }       
  87          
  88          void read_rtc(void)//读取时钟函数
  89          {
  90   1      time_data[0]=read_ds1302(0x8d); //读年份
  91   1      time_data[1]=read_ds1302(0x8b); //读星期
  92   1      time_data[2]=read_ds1302(0x89); //读月
  93   1      time_data[3]=read_ds1302(0x87); //读日
  94   1      time_data[4]=read_ds1302(0x85); //读时
  95   1      time_data[5]=read_ds1302(0x83); //读分
  96   1      time_data[6]=read_ds1302(0x81); //读秒
  97   1      }
  98          
  99          
 100          
 101          void time_proce() //数据处理函数把数据转换为相应的10进制数
 102          {   second1=time_data[6]/16; //转换为10进制数高位
 103   1          second2=time_data[6]%16     ;//转换为10进制数低位
 104   1          minute1=time_data[5]/16;
 105   1          minute2=time_data[5]%16     ;
 106   1          hour1=time_data[4]/16 ;
 107   1          hour2=time_data[4]%16 ;
 108   1          day1=time_data[3]/16;
 109   1          day2=time_data[3]%16;
 110   1              month1=time_data[2]/16;
 111   1          month2=time_data[2]%16;
 112   1              week1=time_data[1]/16;
 113   1          week2=time_data[1]%16;
 114   1              year1=time_data[0]/16;
 115   1          year2=time_data[0]%16;
 116   1      }
 117          
C51 COMPILER V9.00   1                                                                     11/09/2011 14:08:44 PAGE 3   

 118          /*******数码管显示程序************/
 119          
 120          void delay(uint z)    //延时
 121          {
 122   1          uint x,y;
 123   1          for(x=0;x<z;x++)
 124   1              for(y=0;y<110;y++);
 125   1      }
 126          
 127          
 128          void disp_time()//数码显示函数
 129          {
 130   1          P2=bufer[0];
 131   1          P0=table[hour1];
 132   1          delay(5);
 133   1      
 134   1          P2=bufer[1];
 135   1              if(second2%2==0)
 136   1          P0=table[hour2]; 
 137   1          else
 138   1              P0=table_dp[hour2];
 139   1              delay(5);
 140   1      
 141   1          P2=bufer[2];
 142   1          P0=table[minute1];
 143   1          delay(5);   
 144   1      
 145   1          P2=bufer[3];
 146   1          P0=table[minute2];
 147   1          delay(5);
 148   1      
 149   1       }
 150          
 151          
 152          
 153           main(void)   
 154              { 
 155   1      
 156   1      
 157   1        set_rtc(0X80,30);     //设定秒
 158   1        set_rtc(0X82,8);      //设定分
 159   1        set_rtc(0X84,13);     //设定小时
 160   1        set_rtc(0X86,9);      //设定日期
 161   1        set_rtc(0X88,11);     //设定月份
 162   1        set_rtc(0X8A,3);      //设定星期
 163   1        set_rtc(0X8C,11);      //设定年份
 164   1              
 165   1               
 166   1              
 167   1              while(1)
 168   1              { 
 169   2          read_rtc();
 170   2          time_proce();
 171   2              disp_time();//数码显示函数
 172   2       
 173   2               
 174   2               }
 175   1              
 176   1              }


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.00   1                                                                     11/09/2011 14:08:44 PAGE 4   

   CODE SIZE        =    466    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     45       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
